#!/bin/bash
set -euo pipefail

# ─── K8s Instance Init Script ──────────────────────────────────
# Installs k3s with Traefik as the default ingress controller.

export DEBIAN_FRONTEND=noninteractive

echo ">>> Updating system packages..."
apt-get update -y
apt-get upgrade -y

# ─── Install k3s ───────────────────────────────────────────────
echo ">>> Installing k3s..."
curl -sfL https://get.k3s.io | sh -s - \
  --write-kubeconfig-mode 644 \
  --tls-san "$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)"

# Wait for k3s to be ready
echo ">>> Waiting for k3s to be ready..."
until kubectl get nodes &>/dev/null; do
  sleep 2
done

echo ">>> k3s installed successfully!"
kubectl get nodes

# ─── Create namespaces ─────────────────────────────────────────
echo ">>> Creating namespaces..."
kubectl create namespace tellawl --dry-run=client -o yaml | kubectl apply -f -
kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -

# ─── Install ArgoCD ────────────────────────────────────────────
echo ">>> Installing ArgoCD..."
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

echo ">>> Waiting for ArgoCD to be ready..."
kubectl wait --for=condition=Available deployment/argocd-server -n argocd --timeout=300s

echo ">>> K8s instance initialization complete!"
echo ">>> ArgoCD initial password:"
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d
echo ""
